# Taskfile.yml
version: "3"

dotenv: [".env", ".env.local"]

vars:
  BUILD_DIR: ./bin
  BINARY_NAME: api
  GO_FILES: ./cmd/api/main.go

  EXE: main{{exeExt}}

  # Database variables
  # GOOSE_MIGRATIONS_DIR: ./backend/sql/migrations/
  # GOOSE_DRIVER: postgres
  GOOSE_FLAGS: -s # Sequential ordering

# Hide task execution statements | true = hide, false = show (default)
# silent: true

tasks:
  default:
    desc: "Show available tasks"
    cmds:
      - task --list

  go:tidy:
    desc: "Tidy Go modules"
    cmds:
      - go mod tidy

  go:build:
    desc: "Build Go binary"
    cmds:
      - go build -o {{.BUILD_DIR}}/{{.EXE}} ./cmd/web/main.go
      - printf "\nâœ… Go build - {{.BUILD_DIR}}/{{.EXE}} \n\n"
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - "{{.BUILD_DIR}}/{{.BINARY_NAME}}"

  go:
    desc: "Run binary"
    silent: true
    cmds:
      - defer: { task: clean }
      - air

  clean:
    desc: "Clean build artifacts"
    silent: true
    cmds:
      - printf "\n*=== Running Cleanup Process ===*\n"
      - rm -rf bin
      - task: go:tidy
      # - task: podman:down

  health:
    desc: "Check if backend is running"
    cmds:
      - curl -f http://localhost:{{.PORT}}/health || echo "Backend not running"
